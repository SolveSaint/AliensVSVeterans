name: Discussion AutoMod

on:
  discussion_comment:
    types: [created, edited]

permissions:
  discussions: write
  contents: read

jobs:
  moderate:
    runs-on: ubuntu-latest
    steps:
      - name: Moderate comment
        uses: actions/github-script@v7
        with:
          script: |
            const bodyRaw = context.payload.comment?.body || ""
            const bodyLower = bodyRaw.toLowerCase()

            // Normalize common variants so phrase checks are reliable:
            // - smart quotes to ASCII
            // - collapse whitespace
            // - remove zero width chars
            const normalized = bodyLower
              .replace(/[\u200B-\u200D\uFEFF]/g, "")
              .replace(/[’‘]/g, "'")
              .replace(/\s+/g, " ")
              .trim()

            // Helpful: also create a "no punctuation" version to catch youre/youre etc.
            // Keep letters/numbers/spaces and apostrophes for targeted checks.
            const normalizedNoPunct = normalized
              .replace(/[^\p{L}\p{N}\s']/gu, " ")
              .replace(/\s+/g, " ")
              .trim()

            const author = context.payload.comment?.user?.login || "unknown"
            const url = context.payload.comment?.html_url || ""
            const nodeId = context.payload.comment?.node_id

            if (!nodeId) {
              core.info("No comment node_id found. Nothing to do.")
              return
            }

            // Helper: match "you are" / "you're" / "youre" variations without listing all spellings
            // Examples matched:
            // - you're lying
            // - you’re lying
            // - youre lying
            // - you are lying
            // - YOU ARE LYING
            const youAreVariant = String.raw`(?:you\s*are|you\s*'?re|youre)`

            // Phrase patterns that use the helper above
            const attackRegexes = [
              new RegExp(String.raw`\b${youAreVariant}\s+lying\b`, "i"),
              new RegExp(String.raw`\b${youAreVariant}\s+a\s+liar\b`, "i"),
              new RegExp(String.raw`\b${youAreVariant}\s+making\s+(?:this|it)\s+up\b`, "i"),
              new RegExp(String.raw`\b${youAreVariant}\s+delusional\b`, "i"),
              new RegExp(String.raw`\b${youAreVariant}\s+crazy\b`, "i"),
              new RegExp(String.raw`\b${youAreVariant}\s+insane\b`, "i")
            ]

            // Additional direct denial phrases (kept explicit to avoid innocent triggers)
            const denialPhrases = [
              "this is fake",
              "this is a hoax",
              "made up story",
              "pure bullshit",
              "total bullshit",
              "complete bullshit",
              "you made this up",
              "never happened to you"
            ]

            // Mental health dismissal / gaslighting style phrases (explicit only)
            const mentalHealthAttacks = [
              "take your meds",
              "off your meds",
              "get help you need",
              "you need help",
              "schizophrenia",
              "schizophrenic",
              "schizo",
              "psychotic",
              "psychosis"
            ]

            // Slurs: keep as an explicit list (you can extend safely)
            const slurs = [
              "kys",
              "faggot",
              "nigger",
              "retard",
              "kike",
              "spic",
              "chink"
            ]

            // Doxxing style patterns (basic)
            const doxx = [
              /\b\d{3}[-.\s]?\d{3}[-.\s]?\d{4}\b/,                                                   // phone
              /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i,                                           // email
              /\b\d{1,5}\s+\w+(\s+\w+){0,4}\s+(st|street|rd|road|ave|avenue|blvd|lane|ln|dr|drive)\b/i // address-ish
            ]

            const hitSlur =
              slurs.some(s => normalized.includes(s))

            const hitDenial =
              denialPhrases.some(p => normalized.includes(p))

            const hitMental =
              mentalHealthAttacks.some(p => normalized.includes(p))

            const hitAttackRegex =
              attackRegexes.some(rx => rx.test(normalized) || rx.test(normalizedNoPunct))

            const hitDoxx =
              doxx.some(rx => rx.test(bodyRaw))

            const shouldHide = hitSlur || hitDoxx || hitDenial || hitMental || hitAttackRegex

            if (!shouldHide) {
              core.info("No rules hit.")
              return
            }

            const reason =
              hitSlur ? "ABUSE" :
              hitDoxx ? "SPAM"  :
              (hitMental || hitDenial || hitAttackRegex) ? "OFF_TOPIC" :
              "OFF_TOPIC"

            core.warning(`AutoMod minimizing comment. reason=${reason} author=${author} url=${url}`)

            await github.graphql(
              `
              mutation($subjectId: ID!, $classifier: ReportedContentClassifiers!) {
                minimizeComment(input: { subjectId: $subjectId, classifier: $classifier }) {
                  minimizedComment { isMinimized }
                }
              }
              `,
              {
                subjectId: nodeId,
                classifier: reason
              }
            )
